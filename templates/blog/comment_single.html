{% load blog_extras %}

<!-- Single Comment -->
<div class="comment-item mb-4 {% if depth > 0 %}reply-comment{% endif %}" 
     style="margin-left: {{ depth|mul:30 }}px;" 
     data-comment-id="{{ comment.id }}">
    
    <div class="comment-wrapper pb-3 {% if not comment.get_replies %}border-bottom{% endif %}">
        <div class="d-flex align-items-start">
            <!-- Avatar -->
            <div class="comment-avatar me-3 flex-shrink-0">
                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                     style="width: {{ 40|sub:depth|mul:2 }}px; height: {{ 40|sub:depth|mul:2 }}px; font-size: {{ 14|sub:depth }}px;">
                    <i class="fas fa-user"></i>
                </div>
            </div>
            
            <!-- Comment Content -->
            <div class="comment-content flex-grow-1 min-width-0">
                <div class="comment-header mb-2">
                    <h6 class="mb-1 {% if depth > 0 %}fs-6{% endif %} text-break">
                        {{ comment.name }}
                        {% if comment.parent %}
                            <small class="text-muted d-block d-sm-inline">
                                <i class="fas fa-reply me-1"></i>
                                <span class="d-none d-sm-inline">replied to</span> {{ comment.parent.name }}
                            </small>
                        {% endif %}
                    </h6>
                    <small class="text-muted d-block">
                        <i class="fas fa-clock me-1"></i>
                        <span class="d-none d-sm-inline">{{ comment.created_at|date:"F d, Y \a\t g:i A" }}</span>
                        <span class="d-sm-none">{{ comment.created_at|date:"M d, Y" }}</span>
                    </small>
                </div>
                
                <div class="comment-text mb-2 word-wrap-break">
                    {{ comment.content|linebreaks }}
                </div>
                
                <!-- Reply Button -->
                {% if can_reply %}
                    <div class="comment-actions">
                        <button class="btn btn-link btn-sm text-muted p-1 reply-btn d-inline-flex align-items-center" 
                                data-comment-id="{{ comment.id }}" 
                                data-comment-author="{{ comment.name }}">
                            <i class="fas fa-reply me-1"></i>
                            <span class="d-none d-sm-inline">Reply</span>
                            <span class="d-sm-none">Reply</span>
                        </button>
                    </div>
                {% endif %}
                
                <!-- Reply Form (initially hidden) -->
                {% if can_reply %}
                    <div class="reply-form mt-3" id="reply-form-{{ comment.id }}" style="display: none;">
                        <form method="post" class="reply-comment-form">
                            {% csrf_token %}
                            <input type="hidden" name="parent_id" value="{{ comment.id }}">
                            
                            <div class="row g-2 mb-2">
                                <div class="col-12 col-sm-6">
                                    <input type="text" 
                                           name="name" 
                                           class="form-control form-control-sm" 
                                           placeholder="Your Name *" 
                                           required>
                                </div>
                                <div class="col-12 col-sm-6 d-none d-sm-block">
                                    <input type="email" 
                                           name="email" 
                                           class="form-control form-control-sm" 
                                           placeholder="Your Email (optional)">
                                </div>
                            </div>
                            
                            <div class="mb-2">
                                <textarea name="content" 
                                         class="form-control form-control-sm" 
                                         rows="3" 
                                         placeholder="Write your reply to {{ comment.name }}..." 
                                         required></textarea>
                            </div>
                            
                            <div class="d-flex flex-column flex-sm-row gap-2">
                                <button type="submit" class="btn btn-primary btn-sm order-1 order-sm-0">
                                    <i class="fas fa-paper-plane me-1"></i>Reply
                                </button>
                                <button type="button" class="btn btn-secondary btn-sm cancel-reply order-0 order-sm-1">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Render Replies -->
    {% if comment.get_replies and depth < max_depth %}
        <div class="replies mt-3">
            {% for reply in comment.get_replies %}
                {% render_comment reply depth|add:1 max_depth %}
            {% endfor %}
        </div>
    {% elif comment.get_replies and depth >= max_depth %}
        <!-- Show "View more replies" button when max depth is reached -->
        <div class="mt-3 ms-2 ms-sm-3">
            <small class="text-muted d-flex align-items-center">
                <i class="fas fa-plus-circle me-1 flex-shrink-0"></i>
                <span>{{ comment.get_replies.count }} more repl{{ comment.get_replies.count|pluralize:"y,ies" }}</span>
            </small>
        </div>
    {% endif %}
</div>
